{% load static %}
<div class="container mt-4 text-body">
  <h2 class="mb-4">Configuraciones de Pruebas del Laboratorio</h2>

  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Contenedor de mensajes AJAX -->
  <div id="ajax-messages" class="mb-3"></div>
  <script>
    window.showGlobalMessage = function(type, text) {
      const box = document.getElementById('ajax-messages');
      if (!box) return;
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = text;
      box.innerHTML = '';
      box.appendChild(alert);
      setTimeout(() => { if (alert.parentNode) alert.remove(); }, 6000);
    };
  </script>

  <!-- Pruebas pendientes -->
  <h4 class="mb-3">Pruebas pendientes por configurar</h4>
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Prueba</th>
          <th>Instrumento</th>
          <th>Método</th>
          <th>Reactivo</th>
          <th>Unidad de Medida</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for prueba in pending_pruebas %}
          {% include "partials/_crear_config_prueba_row.html" with prueba=prueba %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if not pending_pruebas %}
    <p class="text-muted">No hay pruebas pendientes.</p>
  {% endif %}

  <hr class="my-4" />

  <!-- Pruebas configuradas -->
  <h4 class="mb-3">Pruebas configuradas</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Prueba</th>
          <th>Instrumento</th>
          <th>Método</th>
          <th>Reactivo</th>
          <th>Unidad</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for row in accepted_configs_wrapped %}
          {% include "partials/_config_row.html" with config=row.obj can_edit=row.can_edit %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if not accepted_configs_wrapped %}
    <p class="text-muted">No hay configuraciones aceptadas.</p>
  {% endif %}

  <hr class="my-4" />

  <!-- Propuestas -->
  <h4 class="mb-3">Propuestas de propiedades</h4>
  <div id="propuestas-wrapper" class="table-responsive">
    {% if propuestas %}
      <table id="tabla-propuestas" class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Descripción</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="propuestas-body">
          {% for prop in propuestas %}
            {% include "partials/_propuesta_row.html" with prop=prop %}
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p id="sin-propuestas" class="text-muted">No hay propuestas registradas.</p>
      <table id="tabla-propuestas" class="table table-hover align-middle" style="display:none;">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Descripción</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="propuestas-body"></tbody>
      </table>
    {% endif %}
  </div>

  <!-- Modal Editar Configuración -->
  <div class="modal fade" id="editConfigModal" tabindex="-1" aria-labelledby="editConfigLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editConfigLabel">Editar configuración</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editConfigForm" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="config_id" id="ec-config-id">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Instrumento</label>
                <select class="form-select" name="instrumento_id" id="ec-inst">
                  <option value="">Seleccionar</option>
                  {% for inst in instrumentos %}
                    <option value="{{ inst.id }}">{{ inst.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Método analítico</label>
                <select class="form-select" name="metodo_analitico_id" id="ec-met">
                  <option value="">Seleccionar</option>
                  {% for m in metodos %}
                    <option value="{{ m.id }}">{{ m.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Reactivo</label>
                <select class="form-select" name="reactivo_id" id="ec-reac">
                  <option value="">Seleccionar</option>
                  {% for r in reactivos %}
                    <option value="{{ r.id }}">{{ r.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Unidad de medida</label>
                <select class="form-select" name="unidad_de_medida_id" id="ec-uni">
                  <option value="">Seleccionar</option>
                  {% for u in unidades %}
                    <option value="{{ u.id }}">{{ u.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted" id="ec-status"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success btn-raise" id="ec-save-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Guardar cambios
          </button>
        </div>
      </div>
    </div>
  </div>

</div>



<script>
(function(){
  // Helpers CSRF (Django)
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cs = document.cookie.split(';');
      for (let i=0;i<cs.length;i++){
        const c = cs[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }
  function getCSRFToken(){ return getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''); }

  const modalEl = document.getElementById('editConfigModal');
  const form    = document.getElementById('editConfigForm');
  const saveBtn = document.getElementById('ec-save-btn');
  const status  = document.getElementById('ec-status');
  let currentRow = null;

  // Abrir modal y precargar
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-open-edit-modal');
    if (!btn) return;
    const configId = btn.getAttribute('data-config-id');
    const instId   = btn.getAttribute('data-inst-id') || '';
    const metId    = btn.getAttribute('data-met-id')  || '';
    const reacId   = btn.getAttribute('data-reac-id') || '';
    const uniId    = btn.getAttribute('data-uni-id')  || '';

    // Guardar fila actual
    currentRow = btn.closest('.config-row');

    // Cargar valores al modal
    document.getElementById('ec-config-id').value = configId;
    document.getElementById('ec-inst').value = instId;
    document.getElementById('ec-met').value  = metId;
    document.getElementById('ec-reac').value = reacId;
    document.getElementById('ec-uni').value  = uniId;

    status.textContent = '';
  });

  // Guardar cambios
  saveBtn.addEventListener('click', async function(){
    if (!currentRow) return;

    const url = currentRow.dataset.updateUrl;
    const fd  = new FormData(form);
    // Validación mínima
    const faltantes = [];
    if (!fd.get('instrumento_id'))        faltantes.push('Instrumento');
    if (!fd.get('metodo_analitico_id'))   faltantes.push('Método Analítico');
    if (!fd.get('reactivo_id'))           faltantes.push('Reactivo');
    if (!fd.get('unidad_de_medida_id'))   faltantes.push('Unidad de Medida');
    if (faltantes.length) {
      status.textContent = 'Campos faltantes: ' + faltantes.join(', ');
      return;
    }

    saveBtn.disabled = true;
    saveBtn.querySelector('.spinner-border').classList.remove('d-none');
    try{
      const res = await fetch(url, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': getCSRFToken(), 'X-Requested-With':'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (res.ok) {
        // Refrescar textos en la fila
        const instSel = document.getElementById('ec-inst');
        const metSel  = document.getElementById('ec-met');
        const reacSel = document.getElementById('ec-reac');
        const uniSel  = document.getElementById('ec-uni');

        currentRow.querySelector('.cell-instrumento').textContent = instSel.options[instSel.selectedIndex].text;
        currentRow.querySelector('.cell-metodo').textContent      = metSel.options[metSel.selectedIndex].text;
        currentRow.querySelector('.cell-reactivo').textContent    = reacSel.options[reacSel.selectedIndex].text;
        currentRow.querySelector('.cell-unidad').textContent      = uniSel.options[uniSel.selectedIndex].text;

        // Cerrar modal
        const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
        bsModal.hide();
        // Limpiar estado
        status.textContent = '';
      } else {
        status.textContent = data.error || 'No se pudo actualizar la configuración';
      }
    } catch(err) {
      status.textContent = 'Error de conexión';
    } finally {
      saveBtn.disabled = false;
      saveBtn.querySelector('.spinner-border').classList.add('d-none');
    }
  });
})();
</script>
<script>
// CSRF helpers (Django)
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== '') {
    const cs = document.cookie.split(';');
    for (let i=0;i<cs.length;i++){
      const c = cs[i].trim();
      if (c.substring(0, name.length + 1) === (name + '=')) {
        v = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return v;
}
function getCSRFToken(){ return getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''); }

// Delegación de eventos para botones de edición en la tabla de configuradas
document.addEventListener('click', async function(ev){
  const btn = ev.target.closest('.btn-editar-config, .btn-guardar-config, .btn-cancelar-config');
  if (!btn) return;

  const row = btn.closest('.config-row');
  if (!row) return;

  const viewCells = row.querySelectorAll('.cell-view');
  const editCell  = row.querySelector('.cell-edit');
  const btnEditar  = row.querySelector('.btn-editar-config');
  const btnGuardar = row.querySelector('.btn-guardar-config');
  const btnCancelar= row.querySelector('.btn-cancelar-config');

  // Entrar a modo edición
  if (btn.classList.contains('btn-editar-config')) {
    viewCells.forEach(c => c.classList.add('d-none'));
    editCell.classList.remove('d-none');
    btnEditar.classList.add('d-none');
    btnGuardar.classList.remove('d-none');
    btnCancelar.classList.remove('d-none');
    return;
  }

  // Cancelar edición
  if (btn.classList.contains('btn-cancelar-config')) {
    editCell.classList.add('d-none');
    viewCells.forEach(c => c.classList.remove('d-none'));
    btnEditar.classList.remove('d-none');
    btnGuardar.classList.add('d-none');
    btnCancelar.classList.add('d-none');
    return;
  }

  // Guardar cambios (AJAX)
  if (btn.classList.contains('btn-guardar-config')) {
    const selInst   = row.querySelector('.sel-instrumento');
    const selMet    = row.querySelector('.sel-metodo');
    const selReac   = row.querySelector('.sel-reactivo');
    const selUnidad = row.querySelector('.sel-unidad');

    // Validación rápida cliente
    const faltantes = [];
    if (!selInst.value)   faltantes.push('Instrumento');
    if (!selMet.value)    faltantes.push('Método Analítico');
    if (!selReac.value)   faltantes.push('Reactivo');
    if (!selUnidad.value) faltantes.push('Unidad de Medida');
    if (faltantes.length) {
      window.showGlobalMessage && window.showGlobalMessage('warning', 'Campos faltantes: ' + faltantes.join(', '));
      return;
    }

    // POST
    const url = row.dataset.updateUrl;
    const fd = new FormData();
    fd.append('instrumento_id', selInst.value);
    fd.append('metodo_analitico_id', selMet.value);
    fd.append('reactivo_id', selReac.value);
    fd.append('unidad_de_medida_id', selUnidad.value);

    // Deshabilitar mientras guarda
    btn.disabled = true;
    try{
      const res = await fetch(url, {
        method: 'POST',
        body: fd,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (res.ok) {
        // Actualizar vista de texto con lo seleccionado
        row.querySelector('.cell-instrumento').textContent = selInst.options[selInst.selectedIndex].text;
        row.querySelector('.cell-metodo').textContent      = selMet.options[selMet.selectedIndex].text;
        row.querySelector('.cell-reactivo').textContent    = selReac.options[selReac.selectedIndex].text;
        row.querySelector('.cell-unidad').textContent      = selUnidad.options[selUnidad.selectedIndex].text;

        // Salir de edición
        editCell.classList.add('d-none');
        viewCells.forEach(c => c.classList.remove('d-none'));
        btnEditar.classList.remove('d-none');
        btnGuardar.classList.add('d-none');
        btnCancelar.classList.add('d-none');

        window.showGlobalMessage && window.showGlobalMessage('success', data.message || 'Configuración actualizada');
      } else {
        window.showGlobalMessage && window.showGlobalMessage('danger', data.error || 'No se pudo actualizar la configuración');
      }
    } catch(e) {
      window.showGlobalMessage && window.showGlobalMessage('danger', 'Error de conexión');
    } finally {
      btn.disabled = false;
    }
  }
});
</script>
