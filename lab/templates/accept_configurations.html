{% load static %}
<div class="container mt-4 text-body">
  <h2 class="mb-4">Configuraciones de Pruebas del Laboratorio</h2>

  {% if messages %}
    <div>
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Contenedor de mensajes AJAX -->
  <div id="ajax-messages" class="mb-3"></div>
  <script>
    window.showGlobalMessage = function(type, text) {
      const box = document.getElementById('ajax-messages');
      if (!box) return;
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = text;
      box.innerHTML = '';
      box.appendChild(alert);
      setTimeout(() => { if (alert.parentNode) alert.remove(); }, 6000);
    };
  </script>

  <!-- Pruebas pendientes -->
  <h4 class="mb-3">Pruebas pendientes por configurar</h4>
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th>Prueba</th>
          <th>Instrumento</th>
          <th>Método</th>
          <th>Reactivo</th>
          <th>Unidad de Medida</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for prueba in pending_pruebas %}
          {% include "partials/_crear_config_prueba_row.html" with prueba=prueba %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if not pending_pruebas %}
    <p class="text-muted">No hay pruebas pendientes.</p>
  {% endif %}

  <hr class="my-4" />

  <!-- Pruebas configuradas -->
  <h4 class="mb-3">Pruebas configuradas</h4>
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Prueba</th>
          <th>Instrumento</th>
          <th>Método</th>
          <th>Reactivo</th>
          <th>Unidad</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
      {% for row in accepted_configs_wrapped %}
        {% include "./partials/_config_row.html" with config=row.obj can_edit=row.can_edit %}
      {% empty %}
        <tr>
          <td colspan="6" class="text-muted">No hay configuraciones aceptadas.</td>
        </tr>
      {% endfor %}
    </tbody>
    </table>
  </div>
  {% if not accepted_configs_wrapped %}
    <p class="text-muted">No hay configuraciones aceptadas.</p>
  {% endif %}

  <hr class="my-4" />

  <!-- Propuestas -->
  <h4 class="mb-3">Propuestas de propiedades</h4>
  <div id="propuestas-wrapper" class="table-responsive">
    {% if propuestas %}
      <table id="tabla-propuestas" class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Descripción</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="propuestas-body">
          {% for prop in propuestas %}
            {% include "partials/_propuesta_row.html" with prop=prop %}
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p id="sin-propuestas" class="text-muted">No hay propuestas registradas.</p>
      <table id="tabla-propuestas" class="table table-hover align-middle" style="display:none;">
        <thead class="table-light">
          <tr>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Descripción</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="propuestas-body"></tbody>
      </table>
    {% endif %}
  </div>

  <!-- Modal Editar Configuración -->
  <div class="modal fade" id="editConfigModal" tabindex="-1" aria-labelledby="editConfigLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editConfigLabel">Editar configuración</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="editConfigForm" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="config_id" id="ec-config-id">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Instrumento</label>
                <div class="d-flex gap-2">
                  <select class="form-select" name="instrumento_id" id="ec-inst">
                    <option value="">Seleccionar</option>
                    {% for inst in instrumentos %}
                      <option value="{{ inst.id }}">{{ inst.nombre }}</option>
                    {% endfor %}
                  </select>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-proponer"
                          data-prop-tipo="instrumento"
                          data-target-select="#ec-inst">
                    Proponer
                  </button>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Método analítico</label>
                <div class="d-flex gap-2">
                  <select class="form-select" name="metodo_analitico_id" id="ec-met">
                    <option value="">Seleccionar</option>
                    {% for m in metodos %}
                      <option value="{{ m.id }}">{{ m.nombre }}</option>
                    {% endfor %}
                  </select>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-proponer"
                          data-prop-tipo="metodo"
                          data-target-select="#ec-met">
                    Proponer
                  </button>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Reactivo</label>
                <div class="d-flex gap-2">
                  <select class="form-select" name="reactivo_id" id="ec-reac">
                    <option value="">Seleccionar</option>
                    {% for r in reactivos %}
                      <option value="{{ r.id }}">{{ r.nombre }}</option>
                    {% endfor %}
                  </select>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-proponer"
                          data-prop-tipo="reactivo"
                          data-target-select="#ec-reac">
                    Proponer
                  </button>
                </div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Unidad de medida</label>
                <div class="d-flex gap-2">
                  <select class="form-select" name="unidad_de_medida_id" id="ec-uni">
                    <option value="">Seleccionar</option>
                    {% for u in unidades %}
                      <option value="{{ u.id }}">{{ u.nombre }}</option>
                    {% endfor %}
                  </select>
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-proponer"
                          data-prop-tipo="unidad"
                          data-target-select="#ec-uni">
                    Proponer
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted" id="ec-status"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success btn-raise" id="ec-save-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Guardar cambios
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal reutilizable para Proponer Propiedad -->
  <div class="modal fade" id="proposePropModal" tabindex="-1" aria-labelledby="proposePropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="proposePropLabel">Proponer <span id="pp-tipo-label"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="pp-warning" class="alert alert-warning d-none" role="alert">
            Al proponer un elemento se cancelará la edición de esta configuración y se creará una propuesta pendiente.
          </div>

          <form id="proposePropForm" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="tipo" id="pp-tipo">
            <input type="hidden" name="__target_select" id="pp-target">
            <div class="mb-3">
              <label class="form-label">Valor</label>
              <input type="text" class="form-control" name="valor" id="pp-valor" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripción (opcional)</label>
              <textarea class="form-control" name="descripcion" id="pp-descripcion" rows="2"></textarea>
            </div>
          </form>
          <div class="small text-muted" id="pp-status"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" id="pp-send-btn">Enviar propuesta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Punto de montaje de URL para AJAX -->
  <div id="propose-url-anchor" data-propose-url="{% url 'lab:propose_property' %}"></div>

</div>



<script>
(function(){
  // Helpers CSRF (Django)
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cs = document.cookie.split(';');
      for (let i=0;i<cs.length;i++){
        const c = cs[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }
  function getCSRFToken(){ return getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''); }

  const modalEl = document.getElementById('editConfigModal');
  const form    = document.getElementById('editConfigForm');
  const saveBtn = document.getElementById('ec-save-btn');
  const status  = document.getElementById('ec-status');
  let currentRow = null;

  // Abrir modal y precargar
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-open-edit-modal');
    if (!btn) return;
    const configId = btn.getAttribute('data-config-id');
    const instId   = btn.getAttribute('data-inst-id') || '';
    const metId    = btn.getAttribute('data-met-id')  || '';
    const reacId   = btn.getAttribute('data-reac-id') || '';
    const uniId    = btn.getAttribute('data-uni-id')  || '';

    // Guardar fila actual
    currentRow = btn.closest('.config-row');

    // Cargar valores al modal
    document.getElementById('ec-config-id').value = configId;
    document.getElementById('ec-inst').value = instId;
    document.getElementById('ec-met').value  = metId;
    document.getElementById('ec-reac').value = reacId;
    document.getElementById('ec-uni').value  = uniId;

    status.textContent = '';
  });

  // Guardar cambios
  saveBtn.addEventListener('click', async function(){
    if (!currentRow) return;

    const url = currentRow.dataset.updateUrl;
    const fd  = new FormData(form);
    // Validación mínima
    const faltantes = [];
    if (!fd.get('instrumento_id'))        faltantes.push('Instrumento');
    if (!fd.get('metodo_analitico_id'))   faltantes.push('Método Analítico');
    if (!fd.get('reactivo_id'))           faltantes.push('Reactivo');
    if (!fd.get('unidad_de_medida_id'))   faltantes.push('Unidad de Medida');
    if (faltantes.length) {
      status.textContent = 'Campos faltantes: ' + faltantes.join(', ');
      return;
    }

    saveBtn.disabled = true;
    saveBtn.querySelector('.spinner-border').classList.remove('d-none');
    try{
      const res = await fetch(url, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': getCSRFToken(), 'X-Requested-With':'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (res.ok) {
        // Refrescar textos en la fila
        const instSel = document.getElementById('ec-inst');
        const metSel  = document.getElementById('ec-met');
        const reacSel = document.getElementById('ec-reac');
        const uniSel  = document.getElementById('ec-uni');

        currentRow.querySelector('.cell-instrumento').textContent = instSel.options[instSel.selectedIndex].text;
        currentRow.querySelector('.cell-metodo').textContent      = metSel.options[metSel.selectedIndex].text;
        currentRow.querySelector('.cell-reactivo').textContent    = reacSel.options[reacSel.selectedIndex].text;
        currentRow.querySelector('.cell-unidad').textContent      = uniSel.options[uniSel.selectedIndex].text;

        // Cerrar modal
        const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
        bsModal.hide();
        // Limpiar estado
        status.textContent = '';
      } else {
        status.textContent = data.error || 'No se pudo actualizar la configuración';
      }
    } catch(err) {
      status.textContent = 'Error de conexión';
    } finally {
      saveBtn.disabled = false;
      saveBtn.querySelector('.spinner-border').classList.add('d-none');
    }
  });
})();
</script>
<script>
// CSRF helpers (Django)
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== '') {
    const cs = document.cookie.split(';');
    for (let i=0;i<cs.length;i++){
      const c = cs[i].trim();
      if (c.substring(0, name.length + 1) === (name + '=')) {
        v = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return v;
}
function getCSRFToken(){ return getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''); }

// Delegación de eventos para botones de edición en la tabla de configuradas
document.addEventListener('click', async function(ev){
  const btn = ev.target.closest('.btn-editar-config, .btn-guardar-config, .btn-cancelar-config');
  if (!btn) return;

  const row = btn.closest('.config-row');
  if (!row) return;

  const viewCells = row.querySelectorAll('.cell-view');
  const editCell  = row.querySelector('.cell-edit');
  const btnEditar  = row.querySelector('.btn-editar-config');
  const btnGuardar = row.querySelector('.btn-guardar-config');
  const btnCancelar= row.querySelector('.btn-cancelar-config');

  // Entrar a modo edición
  if (btn.classList.contains('btn-editar-config')) {
    viewCells.forEach(c => c.classList.add('d-none'));
    editCell.classList.remove('d-none');
    btnEditar.classList.add('d-none');
    btnGuardar.classList.remove('d-none');
    btnCancelar.classList.remove('d-none');
    return;
  }

  // Cancelar edición
  if (btn.classList.contains('btn-cancelar-config')) {
    editCell.classList.add('d-none');
    viewCells.forEach(c => c.classList.remove('d-none'));
    btnEditar.classList.remove('d-none');
    btnGuardar.classList.add('d-none');
    btnCancelar.classList.add('d-none');
    return;
  }

  // Guardar cambios (AJAX)
  if (btn.classList.contains('btn-guardar-config')) {
    const selInst   = row.querySelector('.sel-instrumento');
    const selMet    = row.querySelector('.sel-metodo');
    const selReac   = row.querySelector('.sel-reactivo');
    const selUnidad = row.querySelector('.sel-unidad');

    // Validación rápida cliente
    const faltantes = [];
    if (!selInst.value)   faltantes.push('Instrumento');
    if (!selMet.value)    faltantes.push('Método Analítico');
    if (!selReac.value)   faltantes.push('Reactivo');
    if (!selUnidad.value) faltantes.push('Unidad de Medida');
    if (faltantes.length) {
      window.showGlobalMessage && window.showGlobalMessage('warning', 'Campos faltantes: ' + faltantes.join(', '));
      return;
    }

    // POST
    const url = row.dataset.updateUrl;
    const fd = new FormData();
    fd.append('instrumento_id', selInst.value);
    fd.append('metodo_analitico_id', selMet.value);
    fd.append('reactivo_id', selReac.value);
    fd.append('unidad_de_medida_id', selUnidad.value);

    // Deshabilitar mientras guarda
    btn.disabled = true;
    try{
      const res = await fetch(url, {
        method: 'POST',
        body: fd,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin'
      });
      const data = await res.json();

      if (res.ok) {
        // Actualizar vista de texto con lo seleccionado
        row.querySelector('.cell-instrumento').textContent = selInst.options[selInst.selectedIndex].text;
        row.querySelector('.cell-metodo').textContent      = selMet.options[selMet.selectedIndex].text;
        row.querySelector('.cell-reactivo').textContent    = selReac.options[selReac.selectedIndex].text;
        row.querySelector('.cell-unidad').textContent      = selUnidad.options[selUnidad.selectedIndex].text;

        // Salir de edición
        editCell.classList.add('d-none');
        viewCells.forEach(c => c.classList.remove('d-none'));
        btnEditar.classList.remove('d-none');
        btnGuardar.classList.add('d-none');
        btnCancelar.classList.add('d-none');

        window.showGlobalMessage && window.showGlobalMessage('success', data.message || 'Configuración actualizada');
      } else {
        window.showGlobalMessage && window.showGlobalMessage('danger', data.error || 'No se pudo actualizar la configuración');
      }
    } catch(e) {
      window.showGlobalMessage && window.showGlobalMessage('danger', 'Error de conexión');
    } finally {
      btn.disabled = false;
    }
  }
});
</script>
<script>
(function(){
  // Helpers CSRF (Django)
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cs = document.cookie.split(';');
      for (let i=0;i<cs.length;i++){
        const c = cs[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }
  function getCSRFToken(){ return getCookie('csrftoken') || (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''); }

  // Referencias a modales y elementos
  const editModalEl = document.getElementById('editConfigModal');
  const editModal   = editModalEl ? bootstrap.Modal.getOrCreateInstance(editModalEl) : null;
  const ppModalEl   = document.getElementById('proposePropModal');
  const ppModal     = ppModalEl ? bootstrap.Modal.getOrCreateInstance(ppModalEl) : null;
  const ppForm      = document.getElementById('proposePropForm');
  const ppStatus    = document.getElementById('pp-status');      // contenedor de mensajes
  const ppWarning   = document.getElementById('pp-warning');     // aviso condicional
  const ppSendBtn   = document.getElementById('pp-send-btn');
  const urlAnchor   = document.getElementById('propose-url-anchor');
  const proposeURL  = urlAnchor ? urlAnchor.getAttribute('data-propose-url') : null;

  // Tabla de propuestas
  const tbl   = document.getElementById('tabla-propuestas');
  const tbody = document.getElementById('propuestas-body');
  const empty = document.getElementById('sin-propuestas');

  // Utilidad: mostrar estado con estilos de alerta
  function setStatus(msg, tone){ // tone: 'danger'|'warning'|'success'|null
    if (!ppStatus) return;
    ppStatus.className = 'small mt-1';
    if (tone) ppStatus.classList.add('alert', `alert-${tone}`);
    ppStatus.textContent = msg || '';
  }

  // Añadir fila "Pendiente" sin recargar
  function addProposalRow(tipo, valor, descripcion, statusText, id) {
    if (empty) empty.style.display = 'none';
    if (tbl)   tbl.style.display = '';
    if (!tbody) return;
    const tr = document.createElement('tr');
    const tdTipo = document.createElement('td');    tdTipo.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
    const tdVal  = document.createElement('td');    tdVal.textContent  = valor;
    const tdDesc = document.createElement('td');    tdDesc.textContent = descripcion || '-';
    const tdSt   = document.createElement('td');    tdSt.textContent   = statusText || 'Pendiente';
    tr.append(tdTipo, tdVal, tdDesc, tdSt);
    tr.dataset.propuestaId = String(id || '');
    tbody.prepend(tr);
  }

  // Abrir modal de propuesta desde cualquier botón .btn-proponer
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-proponer');
    if (!btn) return;

    const tipo = btn.getAttribute('data-prop-tipo'); // instrumento|metodo|reactivo|unidad
    document.getElementById('pp-tipo').value = tipo;
    document.getElementById('pp-target').value = btn.getAttribute('data-target-select') || '';
    document.getElementById('pp-tipo-label').textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);

    // Mostrar aviso SOLO si está abierto el modal de edición (propuesta desde edición)
    const openedFromEdit = !!(editModalEl && editModalEl.classList.contains('show'));
    if (ppWarning) ppWarning.classList.toggle('d-none', !openedFromEdit);

    ppForm.reset();
    setStatus('', null);
    ppModal && ppModal.show();
  });

  // Enviar propuesta por AJAX
  ppSendBtn?.addEventListener('click', async function(){
    if (!proposeURL) {
      setStatus('No se encontró la URL de propuestas.', 'danger');
      return;
    }
    const fd = new FormData(ppForm);
    const tipo = (fd.get('tipo') || '').toString();
    const valor = (fd.get('valor') || '').toString().trim();
    const descripcion = (fd.get('descripcion') || '').toString().trim();
    if (!valor) {
      setStatus('El valor es obligatorio.', 'warning');
      return;
    }

    ppSendBtn.disabled = true;
    setStatus('Enviando...', null);
    try {
      const res = await fetch(proposeURL, {
        method: 'POST',
        body: fd,
        headers: { 'X-CSRFToken': getCSRFToken(), 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data.ok) {
        setStatus((data && data.error) ? data.error : 'No se pudo registrar la propuesta.', 'danger');
        ppSendBtn.disabled = false;
        return;
      }

      // Cerrar modal de propuesta
      ppModal && ppModal.hide();
      // Si la propuesta salió desde edición, cerrar el modal de edición también
      if (editModalEl && editModalEl.classList.contains('show') && editModal) {
        editModal.hide();
      }

      // Reflejar en la tabla de "Propuestas"
      addProposalRow(tipo, valor, descripcion, 'Pendiente', data.id);

      // Aviso no intrusivo global
      window.showGlobalMessage && window.showGlobalMessage('success', 'Propuesta registrada correctamente');
    } catch (err) {
      setStatus('Error de conexión.', 'danger');
    } finally {
      ppSendBtn.disabled = false;
    }
  });
})();
</script>
